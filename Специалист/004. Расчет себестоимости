Добавляем в регистр ОстаткиНоменклатуры ресурс Себестоимость.
В приходной накладной добавляем вывод поля в запросе, котором происходит схлопывание, при этом поле себестоимость суммируем. После чего проводим его.

В расходной накладной так же добавляем поле себестоимость в запросе, првоеряем его на NULL, и вычисляем себестоимость по формуле, которая исключает плавающую точку - Условие последнего списания:
	Если Выборка.Количество = Выборка.КоличествоОстаток Тогда
		Себестоимость = Выборка.СебестоимостьОстаток;
	Иначе
		Себестоимость = Выборка.СебестоимостьОстаток * Выборка.Количество / Выборка.КоличествоОстаток;
	КонецЕсли;
В случае если, мы продаем весь товар что есть на складе, тогда себестоимость будет просто равна себестоимости, иначе вычисляем ее по формуле в которой деление ставим на споследнее место.
