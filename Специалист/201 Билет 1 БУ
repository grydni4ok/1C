Основа это разрез по срокоам годности.
Для реализации этого создаем в табличной части документа ПриходнаяНакладная реквизит СрокГодности (дата).
В Планы видов характеристик -> ВидыСубконто создаем предопределенный элемент СрокГодности (дата)
Т.к. мы учитываем среднюю цену, а не цену по партиям, для этого нам нужно создать у Планы счетов -> Управленческий -> Признаки учета субконто признак Суммовой.
Затем Регистры бухгалтерии -> Управленческий -> Сумма проставить признак учета субконто - Суммовой
Планы счетов -> Управленческий у счета товары добавить вид субконто СрокГодности, и оставить признак суммовой только у номенклатуры.

При проведении документа расходной накладной, в запросе через левое соединение 2 раза присоединяем таблицу остатков, первый раз вытаскиваем сроки годности, а второй раз сумму
