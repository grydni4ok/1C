Новая методика реализуется только в тех случаях когда в документе есть все нужные нам для записи проведения поля, и нам не нужно ничего рассчитывать. Если же приходится вычислять значение каких либо полей, либо обращаться к бд за их значениями, тогда необходимо реализовать старую обработку проведения.

ОстаткиНоменклатуры нужно разрешить разделение итогов.

Для просмотра значений менеджера временных таблиц, нужно использвать:
  МенеджерВТ.Таблицы[0].ПолучитьДанные().Выгрузить()
  
Для начала создадим запрос, где произведем схлопование по номенклатуре, для подсчета необходимого количества товаров. Произведем отбор по текущему документу, и поместим все это в менеджер временных таблиц, он понадобится нам позже. Выведем полученные данные и сформируем движения.
После формирований движений выставляем флаги записывать истина, блокируем таблицу для изменений и записываем движения.
  // регистр ОстаткиНоменклатуры Расход
	Движения.ОстаткиНоменклатуры.Записывать = Истина;
	//выключение флага разделения итогов
	Движения.ОстаткиНоменклатуры.БлокироватьДляИзменения = Истина;
	Движения.Записать();
  
Далее производим проверку на отрицательные отстатки
Используя менеджер ВТ производим отбор в ОстатакиНоменклатуры по полю номенклатура с помощью созданной нами ранее временной таблицы, а так же по полю Склад. Выставляем условие на вывод отрицательных значений Количесвто. 
Используем Границу времени: 
  Новый Граница(МоментВремени(), ВидГраницы.Включая)
Проверяем, если результат запроса не пустой, то Отказ = Истина, и выводим каких товаров нам не хвататет
