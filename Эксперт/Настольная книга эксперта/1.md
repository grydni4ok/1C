# КАК ИЗМЕРЯТЬ И ПОЛУЧАТЬ ЦИФРЫ

Получить длительность ключевых операций и оценок по шкале APDEX - встроить подсистему "Оценка производительности" из состава БСП.
Ошибки блокировок, системные ошибки, ошибки защиты по ТЖ. Этот алгоритм планируется встаривать в Центр контроля качества (ЦКК).
Аварийные завершения процессов, можно считать по дампам, образующимися при авдении процессов при включенной специальной настройке. Рекомендуется использовать ЦКК, в него уже всьтроен подсчет дампов и их группировка по офсетам.
Зависание кластера нужно отслеживать с помощью ЦКК.

1.	 Получить список жалоб.
2.	 По списку жалоб составить список ключевых операций (ограниченное количество - 20 самый максимум).
3.	 По списку ключевых операций совместно с заказчиком назначить целевое время
и приоритеты.
4.	 Пока идет согласование по п. 3 (это не всегда быстро), можно подключить
и настроить ЦУП, но он не понадобится до этапа 8.
5.	 По списку ключевых операций встроить замеры в базу, получить результаты.
6.	 Сравнить результаты с целевым временем. Операции с плохим фактическим
временем относительно целевого (с плохим APDEX) следует начинать разбирать
в порядке убывания приоритета.
7.	 По каждой операции найти наиболее типичное действие (по гистограмме найти
интервал времени, в который попало наибольшее количество замеров).
8.	 Для этого действия провести анализ, выяснить, что это за действие (как –
описано в этом разделе ниже).
9.	 Понять, с какой проблемой имеем дело, что придется делать, и оценить трудоемкость решения.
10.	 Оформить результаты по п. 7 и 8 в виде отчета, согласовать с заказчиком дальнейшие действия.
11.	 Воплотить рекомендации в жизнь, сравнить результаты с целевым временем.

У проблем производительности есть два обычных подозреваемых:
■ плохая работа запроса,
■ плохая работа кода


--------------------------------------------------------------------------------------------------------------------------------------
## ГЛАВА 3 ТЕОРИЯ

**Ключевая операция (КО)** - это операция (действие) системы, у которой количесвенной характеристикой, определяющей наступление нежелательного состояния, является время выполнения этой оперции, и наступление этого нежелательного состояния является важной проблемой.
Ключевые операции:
  - Всегда начинаются на клиенте
  - Не может состоять из нескольких интерактиных дейсвтвий пользователя, потому что мы оптимизируем систему, а не работу пользователей
  - Ключевая операция всегода заканчивается на клиенте. Мы не можем разбить на несколько КО дейсвие, которое является единым с точки зрения пользователя.

Перечень ключевых операций (нужно заполнить список вместе с клиентом)
Ключевая операция | Приоритет | Целевое время Т (сек.)
                  |           |
                  |           |
                  |           |
Перечень ключевых операций является предварительным и может быть изменен по взаимному согласию сторон.
Целевое время, указанное для каждой ключевой операции, также может уточняться в процессе выполнения работ по договору при наличии объективных причин, например, при несовпадении субъективной оценки пользователей и оценки APDEX.


--------------------------------------------------------------------------------------------------------------------------------------
## 3.2. Методика APDEX

Для вычисления APDEX, необходимо обработать данные по времени выполнения всех ключевых операций и получить следующие значения:
N – общее количество выполнений данной операции
NS – количество выполнений с временем отклика от 0 до Т
NT – количество выполнений с временем отклика от T до 4T
Значение APDEX вычисляется по формуле: APDEX = (NS + NT/2)/N

![Шкала APDEX](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/APDEX.png)

Существует обратная задача – получить целевое время по заданному значению APDEX, если заказчик затрудняется это целевое время назвать.
В системе ОП (оценка производительности) встроен механизм автоматического подбора времени Т под заданное значение APDEX.
Если нудно ручное решение см стр 29.

--------------------------------------------------------------------------------------------------------------------------------------
## Критичные ошибки

Критичные ошибки:
  - Ошибки блокировок
  - системные ошибки
  - ошибки защиты
  - аварийные процессы завершения процессов кластера серверов 1С:Предприятия
  - зависание процессов кластера серверов 1С:Предприятия

**Ошибка блокировок** - называюется ошибка, возникающая при превышении времени ожидания на блокировке (lock request time out) или неразрешимый конфликт блокировок (взаимоблокировка - deadlock).

**Системные ошибка** - ошибка данных информационной базы или ошибка платформы, которая не позволяет пользователю выполнить какое-либо прикладное действие с системой. Любые фукнциональные ошибки кода конфигурации не являются системными ошибками.

**Аварийные завершения процессора кластеров серверов**. Падением кластера серверов 1С:Предприятия называется самопроизвольная выгрузка любого процесса кластера серверов или всех его процессов одновременнно.

**Зависание процессов кластера серверов** - состояние кластера, при котором он не отвечает на запросы пользователей, не позволяет создавать новое клиентское подключение и т.п., но при этом остается загруженным в память рабочего сервера.

--------------------------------------------------------------------------------------------------------------------------------------
## Расчет доступности системы

## Регламентные работы


--------------------------------------------------------------------------------------------------------------------------------------
## 3.6.Транзакции

При выполнении 2х транзакций, не происходит (как правило) полной изоляции одной транзакции от другой. Такое возможно, но это снижает паралельность работы и может приводит к блокировкам.

Проблемы возникающие при взаимодействии 2х транзакций:
  - **потерянное обновление (lost update)** - если один и тот же блок данных (запись + запись) одновременно изменяют 2 разные транзакции, то будет зафиксированно только одно изменение, второе потеряется (при работе 1С не возможно, поскольку не бывает записи вне транзакций);
  - **грязное чтение (dirty read)** - чтение данных, добавленных или измененных транзакцией (запись + чтение), может дать неточный результат, потому что та тарнзакция в последствии может не подтвердится.


Уровни изоляции для СУБД:
  - **Read Uncommited** - (неподтвержденное чтение, изоляций незафиксированного чтения) самый низкий уровень изоляции, указывает, что запросы могут считывать строки, которые были изменены еще не зафиксированными транзакциями. Допускается чтение незафиксированных изменений текущей транзакцией (параллельными транзакциями) и незафиксированных изменений параллельных транзакций (нашей и другими тразакциями). Возможны грязные, неповторяемые чтения и фантомы.
  - **Read Committed Snapshot (Версионники)** - (подтвержденное чтение с включенным параметром READ_COMMITTED_SNAPSHOT).
    Для СУБД MS SQL в 1С поддерживается начиная с версии 8.3 (В 8.2 можно установить свойство READ_COMMITTED_SNAPSHOT настройках, но оно будет каждый раз сбрасываться при реструктаризации).
    В СУБД ORACLE уровень с такими же свойствами используется 1С и в версии 8.2.
    Уровень указывает, что запросы не могут считывать данные, которые были изменены другими транзакциями, но еще не были зафиксированы.
    В момент начала чтения транзакции будет выделен моментальный снимок (snapshot) базы данных, включающий в себя все изменения завершенных к этому моменту времени транзакций. Транзакция может читать этот снимок, получая чистые данные (без «грязного» чтения) и при этом никого не блокируя.
    «Грязные» чтения невозможны, возможны неповторяемые чтения и фантомы.
  - **Read Committed** - (подтвержденное чтение, изоляция зафиксированного чтения).
    Как и уровень Read Committed Snapshot, указывает, что запросы не могут считывать данные, которые были изменены другими транзакциями, но еще не были зафиксированы.
    Привыполненииоперацийчтения текущейтранзакциейиспользуются разделяемые блокировки для предотвращения изменения строк другими транзакциями (время освобождения в общем зависит от того, что блокируется – строка, страница или таблица, но достаточно понимать, что все освобождается после выполнения запроса) и для предотвращения от считывания строк, измененных другими транзакциями, пока они не завершатся. «Грязные» чтения невозможны, возможны неповторяемые чтения и фантомы.


--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------























