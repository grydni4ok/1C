--------------------------------------------------------------------------------------------------------------------------------------
## 4.1. Как настроить сбор информации о загрузке оборудования и как оценить эту загрузку

С помощью Performance monitor в простых случаях достаточно контролировать следующие параметры:
  1. Memory (Память) - Committed bites in use (% использования выделенной памяти) - счетчик показывает процент относительно суммы размера оперативной памяти и файла подкачки, а не только использование оперативной памяти. Не должен превышать размер оперативной памяти.
  2. Memory (Память) - Available Mbytes (Доступно, Мбайт) - счетчик показывает объем свободной физической оперативной памяти. приближение к нулю свидетельствует о недостатке оперативной памяти.
  3. Processor [_Total] (Процессор [_Total]) - % Processor Time (% загрузки процессора) - рекомендованный максимум - не более 70% в течении длительного времени.
  4. System (Система) - Processor Queue Length (Очередь к процессорам) - рекомендованный максимум - не более 2 * количество ядер процессоров в течении длительного времени.
  5. Physical Disk (Физический диск) - Avg/ Disk Queue Length (Средняя длина очереди к дискам) - обязательно для системных дисков отдельно, для дска с базой отдельно, для диска с журналом транзакций (если такой есть) отдельно. Рекомендованный максимум - не более 2 * количество дисков, работающих параллельно (при этом всегда нужно иметь в виду, что RAID0, обеспечивающий параллельность работы дисков, на дисках с базой собирают крайне редко). На практике этот счетчик достаточно слодно применять при оценке загруженности дискового хранилища. По это причине этот счетчик может быть заменен на а \PhysicalDisk(_Total)\Avg. Disk Sec/Read и \PhysicalDisk(_Total)\
Avg. Disk Sec/Write. При работе с дисковым кешем нормальное время на чтение или запись обычно составляет не менее 10 мс. В случае работы с дискамивремя на чтение или запись не должно превышать 50-200 мс. Если вы видите, что есть периоды, в которые среднее время значительно возрастает и превышает 200 мс, то это серьездный повод задуматься о производительности дискового хранилища, с которым вы работаете.
  6. LogicalDisk - % Free Space - показатель наличия свободного места на диске и динамики его изменения.
  7. Network Interface (Сетевой интерфейс) - Bites Total/sec (всего байт/с). Рекомендованный максимум - не более 65% от пропускной способности адаптера в течении длительного времени.

Показатели, на которые нужно обратить особое внимание: % загрузки процессоар, средняя длина очереди к дискам, % использования выделенной памяти. Если эти показатели систематически превышают рекомендованные максимальные значения - то оборудование не справляется с нагрузкой.

**Настройка сбора логов:**  
  - пуск - выполнить - Perfmon
  - Группы сборщиков данных – Особый (правой кнопкой) – Создать – Группа Сборщиков данных
  - Ввести имя (например, 1s), переключатель установить на Создать вручную (для опытных), нажать Далее  
  - Создать журналы данных – установить флажок на Счетчик производительности
  - Используя кнопку Добавить интерфейсов добавления счетчиков из списка:  
      - Memory (Память) – Committed bytes in use (% использования выделенной памяти)  
      - Memory (Память) – Available Mbytes (Доступно, Мбайт);  
      - Processor [_Total] (Процессор [_Total]) – % Processor Time (% загрузки процессора);  
      - System (Система) – Processor Queue Length (Очередь к процессорам);
      - Physical Disk (Физический диск) – Avg. Disk Queue Length (Средняя длина очереди к дискам) – обязательно для системных дисков отдельно, для диска с базой отдельно, для диска с журналом транзакций (если такой есть) отдельно
      - PhysicalDisk (Физический диск) – Avg. Disk Sec/Read (Среднее время чтения с диска в секундах);
      - PhysicalDisk (Физический диск) – Avg. Disk Sec/Write (Среднее время записи на диск в секундах);
      - LogicalDisk (Логический диск) – % Free Space (процент свободного места);
      - Network Interface (Сетевой интерфейс) – Bytes Total/sec (всего байт/с);
  - Когда набрали все счетчики, нажать ОК и Далее.
  - Если не хотите задать другой путь к файлам логов, предложенный путь оставить как есть, нажать Готово (в некоторых версиях – Далее).
  - Если будет задан дополнительный вопрос, поставить переключатель на СохранитьИЗакрыть, нажать Готово
  - Встать на имя группы сборщиков (1s) – Действие – Пуск (или нажать на зеленую стрелку)
  - После этого, даже если завершить сеанс пользователя, сборщик продолжит работу
  - Если надо остановить счетчик или отослать файл, там же надо выполнить пункт меню Действия – Стоп (или нажать на черный квадрат рядом с зеленой стрелкой)

Каждый перезапуск счетчика начнет новый файл.
Длительность замера при указанных настройках неограниченна – счетчик работает, пока его не остановят или не произойдет перезагрузки сервера.


--------------------------------------------------------------------------------------------------------------------------------------  
## 4.2. Выяснение скорости диска  

Утилита SQLIO (disk.zip).

SQLIO – это очень простой инструмент эталонного тестирования производительности операций ввода – вывода дисковой подсистемы для SQL Server. Этот инструмент доступен для свободного скачивания и применения всем легальным пользователям SQL Server.
Запуск:
1.	 Запустить файл SQLIO.bat.
2.	 Примерно через 30 минут результат будет показан на экране в виде диалогового окна.
Будут отображены два показателя: Скорость чтения MB/sec и Скорость записи MB/sec.
Настройка: по умолчанию замеряется скорость для логического диска С. Чтобы измерить скорость другого диска, нужно внести изменения в файл param.txt.  


--------------------------------------------------------------------------------------------------------------------------------------
## 4.3. Настройка автоматического перезапуска сервера «1С»  

**Перезапуск средствами платформы.**  

Рабочие процессы нужно перезапускать регулярно (перезапуск рабочих процессов или агента сервера) - ЕЖЕДНЕВНО.  

![Настройки свойств локального кластера](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%A0%D0%B0%D0%B1%20%D0%9F%D1%80%D0%BE%D1%86.png)  

Секция «Перезапускать рабочие процессы» позволяет настроить их автоматический перезапуск.

**Перезапуск службы средствами операционной системы**  

Если по каким то причинам требуется настроить перезапуск служб средствами операционной системы, можно сделать рестард через планировщик задачь с помощью комнд "net start" и "net stop".  
Перезапускаться в этом случае будет агент, а не рабочие процессы.  
Синтаксис: net start [Имя_службы] и net stop [Имя_службы].  


Задача, состоящая из команд net stop "1C:Enterprise 8.2 Server Agent" и net start "1C:Enterprise 8.2 Server Agent", перезапустит сервер «1С:Предприятия».  
В качестве примера опишем порядок создания этих задач для Windows 7 в самом простом случае:  
1.	 Через управление компьютером войти в планировщик задач, создать новую задачу.    
2.	 На закладке Общие ввести имя, например, «Перезапуск агента 1С» и уточнить, от имени какой учетной записи будет выполняться задача, а также можно поставить флажок Выполнять с наивысшими правами.    
3.	 На закладке Триггеры создать новый триггер – указать, что задача выполняется по расписанию, ежедневно, например, в 22:40.   
4.	 На закладке «Действия»:  
  □ создать новое действие,  
    ○ оставить действие «Запуск программы»,  
    ○ имя программы указать: net,  
    ○ аргументы указать: stop "1C:Enterprise 8.2 Server Agent",  
  □ создать новое действие,  
    ○ оставить действие «Запуск программы»,  
    ○ имя программы указать: net,  
    ○ аргументы указать: start "1C:Enterprise 8.2 Server Agent".    

Зайти в Библиотеку планировщика задач, попробовать выполнить задачу, убедиться, что выполняется то, что требуется. Там же, в библиотеке, можно при необходимости что-то донастроить или изменить как в расписании, так и в других параметрах задачи.


--------------------------------------------------------------------------------------------------------------------------------------
## 4.4. Регламентные операции SQL Server и настройка их автоматического выполнения  

**Общие вопросы**  
Создать план лбслуживания можно при помощи конструктора либо при помощи мастера планов обслуживания.  
Для создания планов обслуживания  и работы с ними пользователь должен быть членом фиксированной серверной роли **sysadmin**.  
Чтобы иметь возможность создавать планы обслуживания, нужно, чтобы был запущен не только сам SQL Server, но и его агент.  

Сам план обслуживания создают следующим образом:
  1. Запустить SQL Management Studio
  2. Открыть ветку Management (Управление), в ней Maintenance Plans (Планы обслуживания), из него вызвать через контекстное меню New Maintenance Plan... (Создать план обслуживания...). Имя плану можно оставить по умолчанию («MaintenancePlan») или дать новое («Регламентные операции»).

**Обновление статистики SQL Server**  
Для обновления статистик по всем таблицам базы данных необходимо выполнить следующий SQL запрос (базу нужно выбирать свою, а не master и не какую либо еще):  
*exec sp_msforeachtable N'UPDATE STATISTICS ? WITH FULLSCAN'*  
**НЕ РЕЖЕ РАЗА В ДЕНЬ**. Выполнение этой и следующей операции тем больше, чем реже их делают, исли делать несколько раз в день, то на производительности почти не скажется (10-15% замедление).

Чтобы обновление статистик выполнялось по расписанию автоматически, нужно сделать следующее:
  1. В ранее созданный план обслуживания (он у нас назывался «MaintenancePlan» или «Регламентные операции») добавить новый вложенный план кнопкой Add Subplan (Добавление вложенного плана). Имя можно дать свое: «Обновление статистик и очистка процедурного кеша» (почему так, станет ясно позднее).
  2. Сразу же в форме создания можно задать расписание (Schedule). Как уже говорилось, рекомендуется выполнять это задание ежедневно.
  3. Перетащить на поле плана с панели элементов задачу Update Statistics Task (Обновление статистики).
  4. Открыть появившуюся задачу двойным щелчком. В появившемся окне выбрать (или потом в поле Database(s) (Базы данных) отметить) нужные базы, остальные поля заполнить

![Настройка свойств задачи обновления статистики](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D1%81%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%20%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8.png)  

  1. Сохранить задачу, нажав ОК.
  2. Сохранить план, например в меню Файл выбрав Сохранить выбранные элементы.
  3. Убедиться, что в срок, указанный в расписании, задание отработало.


--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
