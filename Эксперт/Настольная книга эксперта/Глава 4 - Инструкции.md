--------------------------------------------------------------------------------------------------------------------------------------
## 4.1. Как настроить сбор информации о загрузке оборудования и как оценить эту загрузку

С помощью Performance monitor в простых случаях достаточно контролировать следующие параметры:
  1. Memory (Память) - Committed bites in use (% использования выделенной памяти) - счетчик показывает процент относительно суммы размера оперативной памяти и файла подкачки, а не только использование оперативной памяти. Не должен превышать размер оперативной памяти.
  2. Memory (Память) - Available Mbytes (Доступно, Мбайт) - счетчик показывает объем свободной физической оперативной памяти. приближение к нулю свидетельствует о недостатке оперативной памяти.
  3. Processor [_Total] (Процессор [_Total]) - % Processor Time (% загрузки процессора) - рекомендованный максимум - не более 70% в течении длительного времени.
  4. System (Система) - Processor Queue Length (Очередь к процессорам) - рекомендованный максимум - не более 2 * количество ядер процессоров в течении длительного времени.
  5. Physical Disk (Физический диск) - Avg/ Disk Queue Length (Средняя длина очереди к дискам) - обязательно для системных дисков отдельно, для дска с базой отдельно, для диска с журналом транзакций (если такой есть) отдельно. Рекомендованный максимум - не более 2 * количество дисков, работающих параллельно (при этом всегда нужно иметь в виду, что RAID0, обеспечивающий параллельность работы дисков, на дисках с базой собирают крайне редко). На практике этот счетчик достаточно слодно применять при оценке загруженности дискового хранилища. По это причине этот счетчик может быть заменен на а \PhysicalDisk(_Total)\Avg. Disk Sec/Read и \PhysicalDisk(_Total)\
Avg. Disk Sec/Write. При работе с дисковым кешем нормальное время на чтение или запись обычно составляет не менее 10 мс. В случае работы с дискамивремя на чтение или запись не должно превышать 50-200 мс. Если вы видите, что есть периоды, в которые среднее время значительно возрастает и превышает 200 мс, то это серьездный повод задуматься о производительности дискового хранилища, с которым вы работаете.
  6. LogicalDisk - % Free Space - показатель наличия свободного места на диске и динамики его изменения.
  7. Network Interface (Сетевой интерфейс) - Bites Total/sec (всего байт/с). Рекомендованный максимум - не более 65% от пропускной способности адаптера в течении длительного времени.

Показатели, на которые нужно обратить особое внимание: % загрузки процессоар, средняя длина очереди к дискам, % использования выделенной памяти. Если эти показатели систематически превышают рекомендованные максимальные значения - то оборудование не справляется с нагрузкой.

**Настройка сбора логов:**  
  - пуск - выполнить - Perfmon
  - Группы сборщиков данных – Особый (правой кнопкой) – Создать – Группа Сборщиков данных
  - Ввести имя (например, 1s), переключатель установить на Создать вручную (для опытных), нажать Далее  
  - Создать журналы данных – установить флажок на Счетчик производительности
  - Используя кнопку Добавить интерфейсов добавления счетчиков из списка:  
      - Memory (Память) – Committed bytes in use (% использования выделенной памяти)  
      - Memory (Память) – Available Mbytes (Доступно, Мбайт);  
      - Processor [_Total] (Процессор [_Total]) – % Processor Time (% загрузки процессора);  
      - System (Система) – Processor Queue Length (Очередь к процессорам);
      - Physical Disk (Физический диск) – Avg. Disk Queue Length (Средняя длина очереди к дискам) – обязательно для системных дисков отдельно, для диска с базой отдельно, для диска с журналом транзакций (если такой есть) отдельно
      - PhysicalDisk (Физический диск) – Avg. Disk Sec/Read (Среднее время чтения с диска в секундах);
      - PhysicalDisk (Физический диск) – Avg. Disk Sec/Write (Среднее время записи на диск в секундах);
      - LogicalDisk (Логический диск) – % Free Space (процент свободного места);
      - Network Interface (Сетевой интерфейс) – Bytes Total/sec (всего байт/с);
  - Когда набрали все счетчики, нажать ОК и Далее.
  - Если не хотите задать другой путь к файлам логов, предложенный путь оставить как есть, нажать Готово (в некоторых версиях – Далее).
  - Если будет задан дополнительный вопрос, поставить переключатель на СохранитьИЗакрыть, нажать Готово
  - Встать на имя группы сборщиков (1s) – Действие – Пуск (или нажать на зеленую стрелку)
  - После этого, даже если завершить сеанс пользователя, сборщик продолжит работу
  - Если надо остановить счетчик или отослать файл, там же надо выполнить пункт меню Действия – Стоп (или нажать на черный квадрат рядом с зеленой стрелкой)

Каждый перезапуск счетчика начнет новый файл.
Длительность замера при указанных настройках неограниченна – счетчик работает, пока его не остановят или не произойдет перезагрузки сервера.


--------------------------------------------------------------------------------------------------------------------------------------  
## 4.2. Выяснение скорости диска  

Утилита SQLIO (disk.zip).

SQLIO – это очень простой инструмент эталонного тестирования производительности операций ввода – вывода дисковой подсистемы для SQL Server. Этот инструмент доступен для свободного скачивания и применения всем легальным пользователям SQL Server.
Запуск:
1.	 Запустить файл SQLIO.bat.
2.	 Примерно через 30 минут результат будет показан на экране в виде диалогового окна.
Будут отображены два показателя: Скорость чтения MB/sec и Скорость записи MB/sec.
Настройка: по умолчанию замеряется скорость для логического диска С. Чтобы измерить скорость другого диска, нужно внести изменения в файл param.txt.  


--------------------------------------------------------------------------------------------------------------------------------------
## 4.3. Настройка автоматического перезапуска сервера «1С»  

**Перезапуск средствами платформы.**  

Рабочие процессы нужно перезапускать регулярно (перезапуск рабочих процессов или агента сервера) - ЕЖЕДНЕВНО.  

![Настройки свойств локального кластера](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/%D0%9F%D0%B5%D1%80%D0%B5%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%A0%D0%B0%D0%B1%20%D0%9F%D1%80%D0%BE%D1%86.png)  

Секция «Перезапускать рабочие процессы» позволяет настроить их автоматический перезапуск.

**Перезапуск службы средствами операционной системы**  

Если по каким то причинам требуется настроить перезапуск служб средствами операционной системы, можно сделать рестард через планировщик задачь с помощью комнд "net start" и "net stop".  
Перезапускаться в этом случае будет агент, а не рабочие процессы.  
Синтаксис: net start [Имя_службы] и net stop [Имя_службы].  


Задача, состоящая из команд net stop "1C:Enterprise 8.2 Server Agent" и net start "1C:Enterprise 8.2 Server Agent", перезапустит сервер «1С:Предприятия».  
В качестве примера опишем порядок создания этих задач для Windows 7 в самом простом случае:  
1.	 Через управление компьютером войти в планировщик задач, создать новую задачу.    
2.	 На закладке Общие ввести имя, например, «Перезапуск агента 1С» и уточнить, от имени какой учетной записи будет выполняться задача, а также можно поставить флажок Выполнять с наивысшими правами.    
3.	 На закладке Триггеры создать новый триггер – указать, что задача выполняется по расписанию, ежедневно, например, в 22:40.   
4.	 На закладке «Действия»:  
  □ создать новое действие,  
    ○ оставить действие «Запуск программы»,  
    ○ имя программы указать: net,  
    ○ аргументы указать: stop "1C:Enterprise 8.2 Server Agent",  
  □ создать новое действие,  
    ○ оставить действие «Запуск программы»,  
    ○ имя программы указать: net,  
    ○ аргументы указать: start "1C:Enterprise 8.2 Server Agent".    

Зайти в Библиотеку планировщика задач, попробовать выполнить задачу, убедиться, что выполняется то, что требуется. Там же, в библиотеке, можно при необходимости что-то донастроить или изменить как в расписании, так и в других параметрах задачи.


--------------------------------------------------------------------------------------------------------------------------------------
## 4.4. Регламентные операции SQL Server и настройка их автоматического выполнения  

**Общие вопросы**  
Создать план лбслуживания можно при помощи конструктора либо при помощи мастера планов обслуживания.  
Для создания планов обслуживания  и работы с ними пользователь должен быть членом фиксированной серверной роли **sysadmin**.  
Чтобы иметь возможность создавать планы обслуживания, нужно, чтобы был запущен не только сам SQL Server, но и его агент.  

Сам план обслуживания создают следующим образом:
  1. Запустить SQL Management Studio
  2. Открыть ветку Management (Управление), в ней Maintenance Plans (Планы обслуживания), из него вызвать через контекстное меню New Maintenance Plan... (Создать план обслуживания...). Имя плану можно оставить по умолчанию («MaintenancePlan») или дать новое («Регламентные операции»).

**Обновление статистики SQL Server**  Update Statistics Task (Обновление статистики)  
Для обновления статистик по всем таблицам базы данных необходимо выполнить следующий SQL запрос (базу нужно выбирать свою, а не master и не какую либо еще):  
*exec sp_msforeachtable N'UPDATE STATISTICS ? WITH FULLSCAN'*  
**НЕ РЕЖЕ РАЗА В ДЕНЬ**. Выполнение этой и следующей операции тем больше, чем реже их делают, исли делать несколько раз в день, то на производительности почти не скажется (10-15% замедление).

Чтобы обновление статистик выполнялось по расписанию автоматически, нужно сделать следующее:
  1. В ранее созданный план обслуживания (он у нас назывался «MaintenancePlan» или «Регламентные операции») добавить новый вложенный план кнопкой Add Subplan (Добавление вложенного плана). Имя можно дать свое: «Обновление статистик и очистка процедурного кеша» (почему так, станет ясно позднее).
  2. Сразу же в форме создания можно задать расписание (Schedule). Как уже говорилось, рекомендуется выполнять это задание ежедневно.
  3. Перетащить на поле плана с панели элементов задачу Update Statistics Task (Обновление статистики).
  4. Открыть появившуюся задачу двойным щелчком. В появившемся окне выбрать (или потом в поле Database(s) (Базы данных) отметить) нужные базы, остальные поля заполнить

![Настройка свойств задачи обновления статистики](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D1%81%D0%B2%D0%BE%D0%B9%D1%81%D1%82%D0%B2%20%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B8.png)  

  1. Сохранить задачу, нажав ОК.
  2. Сохранить план, например в меню Файл выбрав Сохранить выбранные элементы.
  3. Убедиться, что в срок, указанный в расписании, задание отработало.

**Очистка процедурного кеша (кеша планов)**  Execute T-SQL Statement Task (задача «Выполнение инструкции T-SQL»).  

Как говорилось раньше, SQL Server должен будет выполнить работу в соответствии с назначенным планом, не имея возможности до следующего раза его поменять. Однако SQL Server может даже этой возможностью не воспользоваться – он запомнит этот план в процедурный кеш, и возможна ситуация, что если будет вызван точно такой же запрос, будет использован план из кеша, даже если статистика поменялась. Поэтому после обновления статистики этот кеш имеет смысл очищать.  

Чтобы процедурный кеш всегда очищался сразу после обновления статистики, его есть смысл включить в тот же план обслуживания «Обновление статистик и очистка процедурного кеша», который выше был настроен для обновления статистики.  
  1. На поле того же вложенного плана надо перетащить задачу Execute T-SQL Statement Task (задача «Выполнение инструкции T-SQL»). Ее надо разметить под предыдущей задачей, и от предыдущей протянуть к ней стрелочку.
  2. Открыть свойства новой задачи двойным щелчком, в поле T-SQL Statement (инструкция T-SQL) ввести текст DBCC FREEPROCCASHE.
  3. Сохранить задачу, нажав ОК
  4. Сохранить план, например, в меню Файл выбрав Сохранить выбранные элементы
  5. Убедиться, что задача выполняется

**Дефрагментация индексов (реиндесация)**  Reorganize Index Task («Реорганизация индекса»)  

Реиндексация – это операция, почти не позволяющая во время ее выполнения, кому-то еще полноценно работать (реиндексация таблиц блокирует их на все время выполнения своей работы). А дефрагментация индексов не блокирует таблицы, а только создает дополнительную нагрузку на SQL Server. А дефаргментация индексов не блокирует таблицы, а только создает дополнительную нагрузку на SQL Server. Поэтому если нет возможности ежедневно выполнять реиндексация, то следует по крайней мере делать  дефрагментацию индексов.  

Чтобы дефрагментация индексов выполнялась по расписанию автоматически, нужно сделать следующее:  
  1. В ранее созданный план обслуживания (он у нас назывался «MaintenancePlan» или «Регламентные операции») добавить новый вложенный план (Subplan).
  2. Задать ему имя, например «Дефрагментация индексов» и расписание.
  3. На поле этого вложенного плана надо перетащить задачу Reorganize Index Task («Реорганизация индекса»).
  4. Открыть свойства задачи двойным щелчком, при необходимости в поле Database(s) («Базы данных») отметить нужные базы, остальные поля настроить
  5. Сохранить задачу, нажав ОК.
  6. Сохранить план, например в меню Файл выбрав Сохранить выбранные элементы.
  7. Убедиться, что задача выполняется.

**Реиндексация таблиц базы** Rebuild Index Task («Перестроение индекса»)  

Реиндексация таблиц базы лучше настраивать через СУБД.  

Чтобы реиндексация базы выполнялась по расписанию автоматически, нужно сделать следующее:  
  1. В ранее созданный план обслуживания (он у нас назывался «MaintenancePlan» или «Регламентные операции») добавить новый вложенный план (Subplan).
  2. Задать ему имя, например «Реиндексация базы» и расписание
  3. На поле этого вложенного плана надо перетащить задачу Rebuild Index Task («Перестроение индекса»)
  4. Открыть свойства задачи двойным щелчком, при необходимости в поле Database(s) («Базы данных») отметить нужные базы, остальные поля настроить
  5. Сохранить задачу, нажав ОК
  6. Сохранить план, например в меню Файл выбрав Сохранить выбранные элементы
  7. Убедиться, что задача выполняется

**Контроль выполнения регламентных заданий**  

  1. После того как пройдет срок, назначенный для первого выполнения регламентного задания каждого вида, открыть ранее созданный план обслуживания (он у нас назывался «MaintenancePlan» или «Регламентные операции») и выбрать из контекстного меню пункт «View History» (Просмотр журнала).
  2. Проставить соответствующие флажки в дереве «Select logs» («Выбор журналов»).

Убедиться, что в журнале есть запись о выполнении и что отметка говорит об успешном выполнении. Если возникла ошибка, о ней нужно там же получить более подробную информацию и принять меры по исправлению.  

Инфорстат настройка обслуживания https://infostart.ru/1c/articles/1661602/. Добавить туда еще очитку процедурного кеша.  


--------------------------------------------------------------------------------------------------------------------------------------
## 4.5. Как включить технологический журнал «1С»  и как его можно разбирать  

Технологический журнал позволяет получать технологическую инфомацию о работе приложения, как сервера, так и клинтов. Позволяет посчитать количество ошибок блокировок.  
Чтобы его включить, нужно выполнить следующие действия:  
  1. Завести на локальных дисках серверов приложений 1С спеуиальную папку для технологического журнала. Например, <C:\LOG>. И для дампов <C:\dumps>.  
  2. Настроить журнал, чтобы сбор сообщений об ошибках происходил в подкаталог этого каталога. Подкаталог будем называть по дате: <C:\LOG\2011-02-16>  
  3. Сам файл logcfg.xml  надо положить в каталог conf папки установки сервера 1С предпреятия
  4. Обратить внимание, что файл нужно помещать в каталог установки сервера, а не клиента, в зависимости от разрядности ОС это может быть либо один и тот же каталог, либо разные.
  5. После этого примерно через минуту убедится, что в каталоге <C:\LOG> создалась папка C:\LOG\2011-02-16, и в ней еще подпапкм с именами rphost_XXXX, ragent_XXXX, rphost_XXXX, а в них файлы. Если же создаеются папки с именами 1с8_ХХХХ, это означанет, что файл logcfg.xml поместили в конфигурационный каталог клиента, а не сервера.
  6. Если папки, создались, то все нормально, если не создались, то что-то не так.
 


--------------------------------------------------------------------------------------------------------------------------------------  
## 4.7. Замеры производительности  

Для начала встраиваем БСП замер производительности, так как указано в книге.  
Втсраиваем замер проиводительнности в код. Можно пользоваться статьей https://infostart.ru/1c/articles/1686856/.  
Как проивходит вставка кода замера производительности для операций начинающихся и заканчивающихся на клиенте:  
  1. Создаем ключевую операцию с вызовом сервера.  
     На клиенте `ВремяНачалаЗамера = СоздатьКлючевуюОперацию();`  
     Код процедуры на сервере  
`&НаСервереБезКонтекста`  
`Функция СоздатьКлючевуюОперацию()`  
`	КлючевыеОперации = Новый Массив();	`  
`	КлючеваяОперация1 = Новый Структура("ИмяКлючевойОперации, ЦелевоеВремя");`  
`	КлючеваяОперация1.ИмяКлючевойОперации = "ПроведениеДокумента3";`  
`	КлючеваяОперация1.ЦелевоеВремя = 1;	`  
`	КлючевыеОперации = Новый Массив;`  
`	КлючевыеОперации.Добавить(КлючеваяОперация1);	`  
`	ОценкаПроизводительности.СоздатьКлючевыеОперации(КлючевыеОперации);`  
`	ВремяНачалаЗамера = ОценкаПроизводительности.НачатьЗамерВремени();	`  
`	Возврат ВремяНачалаЗамера;	`  
`КонецФункции`  
  2. Далее мы выполняем опперции, к которым и должны били быть применены замеры  
  3. На клиенте так же заканчиваем замер производительнсти  
     `ЗакончитьЗамерВремени(ВремяНачалаЗамера);`
  4. На сервере создаем процедуру ЗакончитьЗамерВремени  
`&НаСервереБезКонтекста`  
`Процедура ЗакончитьЗамерВремени(ВремяНачалаЗамера)`
`	ОценкаПроизводительности.ЗакончитьЗамерВремени("ПроведениеДокумента3", ВремяНачалаЗамера, 1, "Проведение документа 3");`
`КонецПроцедуры`

![Встраивание замера производительности](https://github.com/grydni4ok/1C/blob/main/%D0%AD%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82/%D0%9D%D0%B0%D1%81%D1%82%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F%20%D0%BA%D0%BD%D0%B8%D0%B3%D0%B0%20%D1%8D%D0%BA%D1%81%D0%BF%D0%B5%D1%80%D1%82%D0%B0/%D0%9A%D0%B0%D1%80%D1%82%D0%B8%D0%BD%D0%BA%D0%B8/%D0%92%D1%81%D1%82%D1%80%D0%B0%D0%B8%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%B7%D0%B0%D0%BC%D0%B5%D1%80%D0%B0%20%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8.png)  
  
ПроведениеДокумента3 - Название ключевой операции, которая дальше появится в замерах производительности.









  
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------
