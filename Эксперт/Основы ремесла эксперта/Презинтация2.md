# 6. Дополнительная подготовка стенда  
  
## 6.1. Создание «Маленькой базы» и двух баз «Автостоянка»  
Маленькая база  
▪ localhost, tran, postgres, traning  
Автостоянка – postgres  
▪ localhost, pparking, postgres, traning  
Автостоянка – mssql  
▪ localhost, sparking, sa, traning  

Примечния: здесь указаны название баз и данные как и создать и разместить.  
Маленькую базу мы содадим на postgres. И при создании новой базы заполним данные для создания:  
  - Кластер сервверов 1С:предприятия - localhost;  
  - Имя информационной базы в кластере - tran;
  - Тип СУБД - Postgres SQL;
  - Сервер баз данных - localhost;
  - Имя базы данных - tran;
  - Пользователь базы данных - postgres; (здесь будут разные пользователя для разныз СУБД)
  - Пароль пользователя - traning; (у нас здесь будет одинаковый пароль для разных пользователей СУБД).
  
Автостоянку для postgres создадим аналогичным образом.  
Автостоянка для MS SQL будет отличатся только двумя вещами:  
  - Тип СУБД - MS SQL;
  -  Пользователь базы данных - sa.


## 6.2. Включение отладки на сервере  
Ищем строчку из служб в редакторе реестра и добавляем -debug.

Есть 2 пути.  
**Путь превый.** 
  1. Открываем диспетчер задач.
  2. Переходим на вкладу службы. Отсюда через контекстное меню находим "Открыть службы".
  3. В службах находим **"Агент сервера 1С:Предприятия 8.3"**.
  4. Открываем его. Находим исполняемый файл, копируем путь.
  5. Открываем командную строку, в ней вводим **"regedit"**.
  6. Открывается редактор реестра.
  7. Правка - Найти. Вводим нашу строку поиска, ищем. У найденных значений в конце дописываем значение **"-debug"**.
  8. Перезапускаем Агента сервера 1С:Предприятия. Теперь у него в конце исполняемого файла должна появиться запись "-debug".  
  
**Путь второй**  
Такой же как первый единсвенное отличие в п.7. В нем мы не пользуемся поиском, а ищем расположение файла в ручную. У него следующий путь "HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\1C:Enterprise 8.3 Server Agent". Здесь нас интересует файл "ImagePath". У него в конце мы дописываем значение "-debug". 

# 8. Транзакции в «маленькой базе»  

## 8.4. Ручное редактирование настройки ТЖ  

Файл для сохрания логов, нужно создать в папке с 1С, 1cv8\conf. Название **logcfg.xml** (log config).
Основу для файла возмем с ИТС.

Настройки файла логов:  
  - `<eq property="name" value="sdbl"/>` - SDBL - SQL Data Base Language. Для соединения с внешними источниками, в нашем случаае с СУБД.
  - `<eq property="p:processName" value="tran"/>` - для установки отбора только по нужной нам БД. В данном случае БД tran.
  
## 8.5. Begin … Commit  
В технологическом журнале можно отследить транзакции. Для определения открытали транзакция, есть свойство Trans. Если Trans=1 то транзация активна. Trans=0 операции выполняются вне транзаций.  
При начале транзакции помимо установки **Trans=1**, так же появляется значение **Func=BeginTransaction**.  
В сучае успешного выполнения транзакции выставляем значение **Trans=0**, и так же появляется запись о фиксации транзакции **Func=Transaction,Func=CommitTransaction**.  

## 8.6. Begin … Rollback  
При активной транзакции, если ее выполнение закончилось ошибкой, происходит откат транзакии. 
Trans=0,Func=Transaction,Func=RollbackTransaction  
  
Func=setRollbackOnly - указывается в моменте, когда происходит ошибка в транзакции. Можно найти таким способом, где именно произошла ошибка, которая привела к отмене отранзакции. 


# 11. Блокировки (практика)  

## 11.1. Таймаут в «маленькой базе»  

Для ручной отадки таймаутов (взимоблокировок) необходимо прописать настройки файла logcfg.xml. У нас уже есть прописанная настойка по сбору данных sdbl (SQL DataBase Language).  
Необходимо дописать еще ону секцию log для сбора информации, и 3 секции по блокировкам event: tlock, ttimeout, tdeadlock. Для них мы укажем новую папку для сохранения.  
`    
<log location="C:\Logs\TLOCK" history="24">    
		<event>    
			<eq property="name" value="tlock"/>  
			<eq property="p:processName" value="tran"/>  
		</event>  
    <event>  
			<eq property="name" value="ttimelock"/>
			<eq property="p:processName" value="tran"/>
		</event>
    <event>
			<eq property="name" value="tdeadlock"/>
			<eq property="p:processName" value="tran"/>
		</event>
		<property name="all"/> 
	</log>
`  
После этого у нас будут собираться логи в папку TLOCK. Мы рассмотрели простейший TLOCK.  
Как найти TLOCK:
  1. Ищем в логах TTIMEOUT.
  2. Рядом с TTIMEOUT должен быть "большой" TLOCK - "19999992,TLOCK" - TLOCK 19 млн или больше, говорить о том что было превышение ожиданий на блокировках. 20 секунд значение на ожиданиях блокировок по умолчанию. По этому значение близкое к этому 19 или 20 секунда (в ТЖ это 19 или более млн).
  3. В TLOCK содержится информация о блокировках которые мы должны были наложить в секции "Locks".
  4. В TTIMEOUT и в TLOCK есть так же информация о соединении, которое помешало нам наложить блокировку, и кого мы "ждали". За это отвечает "WaitConnection". По полю WaitConnection мы найдем сеанс, пользователя, блокировки которые он наложил и прочее.



11.3. Параллельность управляемых блокировок
11.4. Взаимоблокировки (теория)
11.5. Взаимоблокировка тип 1 в базе ERP
11.6. Взаимоблокировка тип 2 в «маленькой базе»
11.7. Эскалация блокировок
11.8. PostgreSQL в автоматическом режиме управления блокировками
















